<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Where Are My Tax Dollars Going?</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f8f9fb;
  --bg-subtle: #eef1f6;
  --card: #ffffff;
  --card-border: #e2e8f0;
  --card-hover: #f1f5f9;
  --text: #1a2332;
  --text-secondary: #5a6a7e;
  --text-muted: #94a3b8;
  --accent: #6366f1;
  --accent-light: #818cf8;
  --accent-glow: rgba(99,102,241,0.15);
  --emerald: #10b981;
  --amber: #f59e0b;
  --rose: #f43f5e;
  --cyan: #06b6d4;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.08), 0 4px 10px rgba(0,0,0,0.04);
  --radius: 16px;
  --glass: rgba(255,255,255,0.8);
  --glass-border: rgba(0,0,0,0.08);
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 20px;
}

/* ‚ïê‚ïê‚ïê ANIMATED BACKGROUND ‚ïê‚ïê‚ïê */
.bg-pattern {
  position: fixed;
  inset: 0;
  z-index: 0;
  overflow: hidden;
  pointer-events: none;
}

.bg-pattern::before {
  content: '';
  position: absolute;
  width: 600px;
  height: 600px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(99,102,241,0.12) 0%, transparent 70%);
  top: -200px;
  right: -100px;
  animation: floatOrb 20s ease-in-out infinite;
}

.bg-pattern::after {
  content: '';
  position: absolute;
  width: 500px;
  height: 500px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(6,182,212,0.08) 0%, transparent 70%);
  bottom: -150px;
  left: -100px;
  animation: floatOrb 25s ease-in-out infinite reverse;
}

@keyframes floatOrb {
  0%, 100% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(30px, -40px) scale(1.1); }
  66% { transform: translate(-20px, 20px) scale(0.95); }
}

/* Grid overlay */
.bg-grid {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  background-image:
    linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
  background-size: 60px 60px;
  mask-image: radial-gradient(ellipse 80% 60% at 50% 30%, black 40%, transparent 100%);
}

/* ‚ïê‚ïê‚ïê HEADER / HERO ‚ïê‚ïê‚ïê */
header {
  position: relative;
  z-index: 1;
  text-align: center;
  padding: 72px 20px 48px;
  overflow: hidden;
}

.header-flags-bg {
  position: absolute;
  inset: -20px;
  display: flex;
  flex-wrap: wrap;
  align-content: center;
  justify-content: center;
  gap: 12px;
  opacity: 0.07;
  pointer-events: none;
  user-select: none;
  overflow: hidden;
  z-index: 0;
  mask-image: radial-gradient(ellipse 65% 65% at 50% 45%, black 15%, transparent 65%);
  -webkit-mask-image: radial-gradient(ellipse 65% 65% at 50% 45%, black 15%, transparent 65%);
}

.header-flags-bg img {
  width: 36px;
  height: 27px;
  border-radius: 3px;
  object-fit: cover;
}

.header-badge, header h1, header p {
  position: relative;
  z-index: 1;
}

.header-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(99,102,241,0.12);
  border: 1px solid rgba(99,102,241,0.2);
  color: var(--accent-light);
  font-size: 0.78rem;
  font-weight: 600;
  padding: 6px 16px;
  border-radius: 100px;
  margin-bottom: 20px;
  letter-spacing: 0.03em;
  animation: fadeInDown 0.6s ease;
}

header h1 {
  font-size: clamp(2rem, 5vw, 3.2rem);
  font-weight: 900;
  letter-spacing: -0.03em;
  line-height: 1.1;
  margin-bottom: 16px;
  animation: fadeInDown 0.7s ease;
  background: linear-gradient(135deg, #1a2332 0%, #4f46e5 50%, #6366f1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

header p {
  font-size: 1.1rem;
  color: var(--text-secondary);
  max-width: 520px;
  margin: 0 auto;
  font-weight: 300;
  animation: fadeInDown 0.8s ease;
}

.tagline-highlight {
  color: var(--accent-light);
  font-weight: 500;
}

@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(-16px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ‚ïê‚ïê‚ïê INPUT CARD ‚ïê‚ïê‚ïê */
.input-card {
  position: relative;
  z-index: 1;
  background: #ffffff;
  border: 1px solid var(--card-border);
  border-radius: 20px;
  padding: 40px;
  max-width: 560px;
  margin: 0 auto 56px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.06), 0 1px 4px rgba(0,0,0,0.04);
  animation: fadeInUp 0.7s ease;
  transition: box-shadow 0.3s, border-color 0.3s;
}

.input-card:hover {
  box-shadow: 0 8px 40px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
  border-color: #cbd5e1;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(24px); }
  to { opacity: 1; transform: translateY(0); }
}

.input-grid {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-bottom: 28px;
}

.input-group {
  display: flex;
  flex-direction: column;
}

.input-group label {
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 8px;
}

.input-group select,
.input-group input {
  padding: 12px 14px;
  border: 1.5px solid var(--card-border);
  border-radius: 10px;
  font-size: 0.95rem;
  font-family: inherit;
  color: var(--text);
  background: #fff;
  transition: all 0.25s ease;
  outline: none;
  width: 100%;
}

.input-group select {
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  padding-right: 36px;
  cursor: pointer;
}

.input-group select option {
  background: #fff;
  color: var(--text);
}

.input-group select:focus,
.input-group input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.input-group input::placeholder {
  color: var(--text-muted);
}

.income-group {
  position: relative;
}

.income-group label {
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 8px;
  display: block;
}

.income-input-wrap {
  position: relative;
  display: flex;
  align-items: center;
}

.income-input-wrap .dollar-sign {
  position: absolute;
  left: 14px;
  color: var(--text-muted);
  font-weight: 600;
  font-size: 1.2rem;
  pointer-events: none;
  z-index: 1;
}

.income-input-wrap input {
  width: 100%;
  padding: 14px 14px 14px 32px;
  border: 1.5px solid var(--card-border);
  border-radius: 10px;
  font-size: 1.25rem;
  font-weight: 700;
  font-family: inherit;
  color: var(--text);
  background: #fff;
  transition: all 0.25s ease;
  outline: none;
  letter-spacing: 0.01em;
}

.income-input-wrap input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.btn-show {
  display: block;
  width: 100%;
  padding: 14px 24px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.25s ease;
  position: relative;
  overflow: hidden;
  letter-spacing: 0.02em;
}

.btn-show::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, #818cf8, #a78bfa);
  opacity: 0;
  transition: opacity 0.25s;
}

.btn-show:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 24px rgba(99,102,241,0.35);
}

.btn-show:hover::before {
  opacity: 1;
}

.btn-show:active {
  transform: translateY(0) scale(0.98);
}

.btn-show span {
  position: relative;
  z-index: 1;
}

.btn-show .btn-arrow {
  display: inline-block;
  transition: transform 0.25s;
}

.btn-show:hover .btn-arrow {
  transform: translateX(4px);
}

.filing-note {
  text-align: center;
  font-size: 0.78rem;
  color: var(--text-muted);
  margin-top: 14px;
  font-weight: 400;
}

@media (max-width: 500px) {
  .input-row { grid-template-columns: 1fr; }
  .input-card { padding: 28px 24px; }
}

/* ‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê */
#results {
  display: none;
  position: relative;
  z-index: 1;
}

/* ‚ïê‚ïê‚ïê SCROLL REVEAL ‚ïê‚ïê‚ïê */
.reveal {
  opacity: 0;
  transform: translateY(30px);
  transition: opacity 0.6s ease, transform 0.6s ease;
}

.reveal.visible {
  opacity: 1;
  transform: translateY(0);
}

.reveal:nth-child(2) { transition-delay: 0.1s; }
.reveal:nth-child(3) { transition-delay: 0.2s; }
.reveal:nth-child(4) { transition-delay: 0.3s; }

/* ‚ïê‚ïê‚ïê SUMMARY BAR ‚ïê‚ïê‚ïê */
.summary-bar {
  background: linear-gradient(135deg, rgba(99,102,241,0.15) 0%, rgba(6,182,212,0.1) 50%, rgba(16,185,129,0.1) 100%);
  border: 1px solid rgba(99,102,241,0.15);
  border-radius: var(--radius);
  padding: 32px;
  margin-bottom: 40px;
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  gap: 20px;
  backdrop-filter: blur(10px);
}

.summary-item {
  text-align: center;
}

.summary-item .label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-secondary);
  margin-bottom: 6px;
  font-weight: 500;
}

.summary-item .icon {
  font-size: 1rem;
  margin-right: 2px;
}

.summary-item .value {
  font-size: 1.7rem;
  font-weight: 800;
  letter-spacing: -0.02em;
  color: var(--text);
}

/* Count-up animation placeholder class */
.count-up {
  display: inline-block;
}

/* ‚ïê‚ïê‚ïê BRACKET DETAIL PANELS ‚ïê‚ïê‚ïê */
.clickable-rate {
  cursor: pointer;
  transition: background 0.2s;
  border-radius: 12px;
  padding: 8px 12px !important;
}

.clickable-rate:hover {
  background: rgba(99,102,241,0.08);
}

.rate-subtitle {
  font-size: 0.72rem;
  color: var(--text-muted);
  margin-top: 2px;
  font-weight: 400;
}

.bracket-detail-panel {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 24px 28px;
  margin-bottom: 20px;
  animation: fadeInUp 0.3s ease;
}

.bracket-detail-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.bracket-detail-header h3 {
  font-size: 1rem;
  font-weight: 700;
}

.bracket-close {
  background: none;
  border: 1px solid var(--card-border);
  border-radius: 8px;
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 0.9rem;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.bracket-close:hover {
  background: var(--bg-subtle);
  color: var(--text);
}

.bracket-row {
  display: grid;
  grid-template-columns: 1fr 80px 1fr 90px;
  gap: 8px;
  padding: 10px 0;
  font-size: 0.85rem;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  align-items: center;
}

.bracket-row:last-child {
  border-bottom: none;
}

.bracket-row.bracket-header {
  font-weight: 700;
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  border-bottom: 2px solid var(--card-border);
  padding-bottom: 8px;
}

.bracket-row.bracket-active {
  background: rgba(99,102,241,0.06);
  border-radius: 8px;
  padding-left: 8px;
  padding-right: 8px;
  margin-left: -8px;
  margin-right: -8px;
  font-weight: 600;
}

.bracket-row .bracket-range {
  color: var(--text-secondary);
}

.bracket-row .bracket-rate {
  font-weight: 700;
  color: var(--accent);
  text-align: center;
}

.bracket-row .bracket-tax {
  text-align: right;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}

.bracket-row .bracket-bar {
  position: relative;
  height: 6px;
  background: var(--bg-subtle);
  border-radius: 3px;
  overflow: hidden;
}

.bracket-row .bracket-bar-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 3px;
  transition: width 0.6s ease;
}

.bracket-total-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0 0;
  margin-top: 8px;
  border-top: 2px solid var(--card-border);
  font-weight: 800;
  font-size: 0.95rem;
}

.bracket-effective {
  margin-top: 8px;
  font-size: 0.82rem;
  color: var(--text-secondary);
}

@media (max-width: 700px) {
  .bracket-row {
    grid-template-columns: 1fr 60px 1fr 70px;
    font-size: 0.78rem;
  }
}

/* ‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê */
.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 28px;
  margin-bottom: 40px;
}

.chart-card {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 32px;
  transition: all 0.3s ease;
}

.chart-card:hover {
  background: var(--card-hover);
  border-color: rgba(255,255,255,0.12);
  transform: translateY(-2px);
  box-shadow: 0 16px 48px rgba(0,0,0,0.2);
}

.chart-card h2 {
  font-size: 1.15rem;
  font-weight: 700;
  margin-bottom: 4px;
  color: var(--text);
}

.chart-card .chart-subtitle {
  font-size: 0.88rem;
  color: var(--text-secondary);
  margin-bottom: 24px;
  font-weight: 300;
}

.chart-wrapper {
  position: relative;
  max-width: 340px;
  margin: 0 auto;
}

.chart-center-label {
  display: none;
}

.chart-center-label .center-amount {
  font-size: 1.3rem;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.02em;
}

.chart-center-label .center-label {
  font-size: 0.7rem;
  color: #94a3b8;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-weight: 500;
}

/* ‚ïê‚ïê‚ïê RECEIPT ‚ïê‚ïê‚ïê */
.receipt-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 28px;
  margin-bottom: 40px;
}

.receipt-card {
  background: #fefcf3;
  border-radius: 4px;
  padding: 0;
  position: relative;
  color: #2a2a2a;
  box-shadow: 0 4px 24px rgba(0,0,0,0.3);
  overflow: visible;
}

/* Torn top edge */
.receipt-card::before {
  content: '';
  position: absolute;
  top: -8px;
  left: 0;
  right: 0;
  height: 16px;
  background: linear-gradient(135deg, var(--bg) 33.33%, transparent 33.33%) 0 0,
              linear-gradient(225deg, var(--bg) 33.33%, transparent 33.33%) 0 0;
  background-size: 12px 16px;
  background-repeat: repeat-x;
  z-index: 2;
}

/* Torn bottom edge */
.receipt-card::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 0;
  right: 0;
  height: 16px;
  background: linear-gradient(315deg, var(--bg) 33.33%, transparent 33.33%) 0 0,
              linear-gradient(45deg, var(--bg) 33.33%, transparent 33.33%) 0 0;
  background-size: 12px 16px;
  background-repeat: repeat-x;
  z-index: 2;
}

.receipt-inner {
  padding: 32px 28px 36px;
  background:
    repeating-linear-gradient(
      0deg,
      transparent,
      transparent 27px,
      rgba(0,0,0,0.03) 27px,
      rgba(0,0,0,0.03) 28px
    );
}

.receipt-header {
  text-align: center;
  padding-bottom: 16px;
  margin-bottom: 16px;
  border-bottom: 2px dashed #ccc;
}

.receipt-header h3 {
  font-size: 1rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: #1a1a1a;
  margin-bottom: 2px;
}

.receipt-header .receipt-date {
  font-size: 0.72rem;
  color: #888;
  font-weight: 400;
  letter-spacing: 0.04em;
}

.receipt-line {
  display: flex;
  justify-content: space-between;
  padding: 7px 0;
  font-size: 0.85rem;
  border-bottom: 1px dotted #ddd;
  transition: all 0.2s ease;
  border-radius: 2px;
  position: relative;
}

.receipt-line:hover {
  background: rgba(99,102,241,0.06);
  padding-left: 6px;
  padding-right: 6px;
  margin-left: -6px;
  margin-right: -6px;
}

.receipt-line .pct-tag {
  position: absolute;
  right: -4px;
  top: -10px;
  background: #6366f1;
  color: #fff;
  font-size: 0.62rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 4px;
  opacity: 0;
  transform: translateY(4px);
  transition: all 0.2s ease;
  pointer-events: none;
}

.receipt-line:hover .pct-tag {
  opacity: 1;
  transform: translateY(0);
}

.receipt-line:last-of-type {
  border-bottom: none;
}

.receipt-line .cat {
  color: #555;
  font-weight: 400;
}

.receipt-line .amt {
  font-weight: 700;
  color: #1a1a1a;
  font-variant-numeric: tabular-nums;
}

.receipt-total {
  display: flex;
  justify-content: space-between;
  padding: 14px 0 0;
  margin-top: 10px;
  border-top: 2px dashed #333;
  font-weight: 800;
  font-size: 1.05rem;
  color: #1a1a1a;
}

.receipt-thankyou {
  text-align: center;
  margin-top: 18px;
  padding-top: 14px;
  border-top: 1px dashed #ccc;
  font-size: 0.72rem;
  color: #999;
  letter-spacing: 0.06em;
  text-transform: uppercase;
}

.no-tax-note {
  padding: 24px;
  text-align: center;
  color: var(--text-secondary);
  font-style: italic;
}

/* ‚ïê‚ïê‚ïê SECTION LABELS ‚ïê‚ïê‚ïê */
.section-label {
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--accent);
  margin-bottom: 16px;
  padding-left: 2px;
}

/* ‚ïê‚ïê‚ïê STATE VS STATE COMPARISON ‚ïê‚ïê‚ïê */
.compare-controls {
  display: flex;
  align-items: end;
  gap: 16px;
  margin-bottom: 24px;
}

.compare-select-group {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.compare-select-group label {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 6px;
}

.compare-select-group select {
  padding: 12px 14px;
  border: 1.5px solid var(--card-border);
  border-radius: 10px;
  font-size: 0.95rem;
  font-family: inherit;
  color: var(--text);
  background: var(--bg);
  outline: none;
  transition: all 0.3s ease;
}

.compare-select-group select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.compare-vs {
  font-size: 0.85rem;
  font-weight: 800;
  color: var(--text-muted);
  padding-bottom: 14px;
  flex-shrink: 0;
}

.compare-summary {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 16px;
  margin-bottom: 28px;
  align-items: center;
}

.compare-state-box {
  background: var(--bg-subtle);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.compare-state-box .cs-name {
  font-size: 0.72rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

.compare-state-box .cs-tax {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.02em;
}

.compare-state-box .cs-rate {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-top: 2px;
}

.compare-diff {
  text-align: center;
  padding: 16px;
}

.compare-diff .diff-amount {
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 2px;
}

.compare-diff .diff-label {
  font-size: 0.75rem;
  color: var(--text-muted);
}

.compare-diff.savings { color: var(--emerald); }
.compare-diff.extra { color: var(--rose); }

.compare-chart-wrapper {
  position: relative;
  height: 340px;
}

/* ‚ïê‚ïê‚ïê NATIONAL COMPARISON ‚ïê‚ïê‚ïê */
.deviation-list {
  margin-top: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.deviation-tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 100px;
  font-size: 0.78rem;
  font-weight: 600;
}

.deviation-tag.higher {
  background: rgba(244,63,94,0.1);
  border: 1px solid rgba(244,63,94,0.2);
  color: var(--rose);
}

.deviation-tag.lower {
  background: rgba(16,185,129,0.1);
  border: 1px solid rgba(16,185,129,0.2);
  color: var(--emerald);
}

/* ‚ïê‚ïê‚ïê RANKINGS ‚ïê‚ïê‚ïê */
.rankings-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-bottom: 40px;
}

.ranking-card {
  text-align: center;
}

.ranking-card h3 {
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 2px;
}

.rank-value {
  font-size: 2rem;
  font-weight: 900;
  color: var(--accent);
  margin: 12px 0 16px;
  letter-spacing: -0.03em;
}

.rank-bar-container {
  position: relative;
  height: 32px;
  background: var(--bg-subtle);
  border-radius: 8px;
  overflow: hidden;
}

.rank-bar-track {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
}

.rank-marker {
  position: absolute;
  width: 4px;
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: left 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.rank-bar-labels {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
  font-size: 0.68rem;
  color: var(--text-muted);
  font-weight: 500;
}

@media (max-width: 700px) {
  .compare-controls { flex-direction: column; }
  .compare-vs { padding: 0; }
  .compare-summary { grid-template-columns: 1fr; }
  .rankings-grid { grid-template-columns: 1fr; }
}

/* ‚ïê‚ïê‚ïê TOTAL BUDGET BREAKDOWN ‚ïê‚ïê‚ïê */
.budget-breakdown-section {
  margin-bottom: 40px;
}

.budget-toggle-btn {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 24px 28px;
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  cursor: pointer;
  font-family: inherit;
  transition: all 0.3s ease;
  color: var(--text);
}

.budget-toggle-btn:hover {
  background: var(--card-hover);
  border-color: var(--accent);
  transform: translateY(-1px);
  box-shadow: var(--shadow-lg);
}

.budget-toggle-left {
  text-align: left;
}

.budget-toggle-hint {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 4px;
}

.budget-toggle-title {
  font-size: 1.15rem;
  font-weight: 700;
}

.budget-toggle-arrow {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--accent);
  transition: transform 0.3s;
}

.budget-toggle-btn.open .budget-toggle-arrow {
  transform: rotate(90deg);
}

.budget-collapse {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.budget-collapse.open {
  max-height: 6000px;
}

.budget-collapse-inner {
  padding-top: 24px;
}

.budget-card {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 32px;
  margin-bottom: 20px;
  transition: all 0.3s ease;
}

.budget-card:hover {
  background: var(--card-hover);
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.budget-card h3 {
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 4px;
}

.budget-card .budget-total-line {
  font-size: 0.88rem;
  color: var(--text-secondary);
  margin-bottom: 20px;
  font-weight: 300;
}

.budget-bar-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 0;
  font-size: 0.85rem;
}

.budget-bar-label {
  width: 180px;
  flex-shrink: 0;
  color: var(--text-secondary);
  font-weight: 400;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.budget-bar-track {
  flex: 1;
  height: 22px;
  background: var(--bg-subtle);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
}

.budget-bar-fill {
  height: 100%;
  border-radius: 6px;
  transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  min-width: 2px;
}

.budget-bar-amount {
  width: 80px;
  flex-shrink: 0;
  text-align: right;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  color: var(--text);
  font-size: 0.82rem;
}

@media (max-width: 700px) {
  .budget-bar-label { width: 120px; font-size: 0.78rem; }
  .budget-bar-amount { width: 60px; font-size: 0.75rem; }
  .budget-card { padding: 20px; }
}

/* ‚ïê‚ïê‚ïê LOCAL PLACEHOLDER ‚ïê‚ïê‚ïê */
.local-placeholder {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 36px;
  text-align: center;
  margin-bottom: 56px;
  transition: all 0.3s;
}

.local-placeholder:hover {
  border-color: rgba(255,255,255,0.12);
}

.local-placeholder h3 {
  font-size: 1.15rem;
  margin-bottom: 8px;
  color: var(--text);
}

.local-placeholder p {
  color: var(--text-secondary);
  font-size: 0.9rem;
  font-weight: 300;
}

.local-placeholder .coming-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(16,185,129,0.1);
  border: 1px solid rgba(16,185,129,0.2);
  color: var(--emerald);
  font-size: 0.75rem;
  font-weight: 600;
  padding: 5px 14px;
  border-radius: 100px;
  margin-bottom: 14px;
  letter-spacing: 0.04em;
}

/* ‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê */
footer {
  position: relative;
  z-index: 1;
  text-align: center;
  padding: 40px 20px 64px;
  border-top: 1px solid rgba(255,255,255,0.05);
}

.footer-cta {
  margin-bottom: 24px;
}

.footer-cta p {
  font-size: 0.95rem;
  color: var(--text-secondary);
  margin-bottom: 12px;
}

.share-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 22px;
  background: rgba(255,255,255,0.06);
  border: 1px solid #e2e8f0;
  border-radius: 100px;
  color: var(--text);
  font-size: 0.85rem;
  font-weight: 500;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.3s;
}

.share-btn:hover {
  background: rgba(99,102,241,0.15);
  border-color: rgba(99,102,241,0.3);
  transform: translateY(-1px);
}

footer .fine-print {
  font-size: 0.78rem;
  color: var(--text-muted);
  line-height: 1.8;
}

footer a {
  color: var(--accent-light);
  text-decoration: none;
  transition: color 0.2s;
}

footer a:hover {
  color: #a5b4fc;
}

/* ‚ïê‚ïê‚ïê MOBILE ‚ïê‚ïê‚ïê */
@media (max-width: 700px) {
  header { padding: 48px 20px 32px; }
  header h1 { font-size: 2rem; }
  .charts-grid, .receipt-grid { grid-template-columns: 1fr; }
  .summary-bar { padding: 24px 16px; flex-direction: column; align-items: stretch; }
  .summary-item { text-align: left; display: flex; justify-content: space-between; align-items: center; }
  .summary-item .label { margin-bottom: 0; }
  .summary-item .value { font-size: 1.3rem; }
  .chart-card { padding: 24px; }
  .receipt-inner { padding: 24px 20px 28px; }
}

/* ‚ïê‚ïê‚ïê SCROLLBAR ‚ïê‚ïê‚ïê */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
</style>
</head>
<body>

<div class="bg-pattern"></div>
<div class="bg-grid"></div>

<header>
  <div class="header-flags-bg" id="headerFlagsBg" aria-hidden="true"></div>
  <div class="header-badge">üìä 2025 Tax Year ¬∑ Updated Data</div>
  <h1>Where Are My Tax<br>Dollars Going?</h1>
  <p>See exactly how your federal and state income taxes are spent ‚Äî <span class="tagline-highlight">down to the dollar</span>.</p>
</header>

<div class="container">
  <div class="input-card">
    <div class="input-grid">
      <div class="income-group">
        <label for="income">Annual Income</label>
        <div class="income-input-wrap">
          <span class="dollar-sign">$</span>
          <input type="text" id="income" inputmode="numeric" value="75,000" autocomplete="off" placeholder="75,000">
        </div>
      </div>
      <div class="input-group">
        <label for="state">State</label>
        <select id="state"></select>
      </div>
    </div>
    <button class="btn-show" onclick="calculate()"><span>Show Me Where It Goes <span class="btn-arrow">‚Üí</span></span></button>
    <p class="filing-note">Single filer ¬∑ Standard deduction ¬∑ 2025 tax year</p>
  </div>

  <div id="results">
    <div class="summary-bar reveal">
      <div class="summary-item">
        <div class="label"><span class="icon">üí∞</span> Gross Income</div>
        <div class="value" id="sumIncome">‚Äî</div>
      </div>
      <div class="summary-item">
        <div class="label"><span class="icon">üèõÔ∏è</span> Federal Tax</div>
        <div class="value" id="sumFederal">‚Äî</div>
      </div>
      <div class="summary-item">
        <div class="label" id="sumStateLabel"><span class="icon">üó∫Ô∏è</span> State Tax</div>
        <div class="value" id="sumState">‚Äî</div>
      </div>
      <div class="summary-item clickable-rate" onclick="toggleBracketDetail('fed')">
        <div class="label"><span class="icon">üìä</span> Federal Rates <span style="font-size:0.65rem;opacity:0.6;">‚ñº</span></div>
        <div class="value" id="sumFedRate">‚Äî</div>
        <div class="rate-subtitle" id="sumFedRateSub"></div>
      </div>
      <div class="summary-item clickable-rate" onclick="toggleBracketDetail('state')">
        <div class="label" id="sumStateRateLabel"><span class="icon">üìä</span> State Rates <span style="font-size:0.65rem;opacity:0.6;">‚ñº</span></div>
        <div class="value" id="sumStateRate">‚Äî</div>
        <div class="rate-subtitle" id="sumStateRateSub"></div>
      </div>
    </div>

    <!-- Bracket Detail Panels -->
    <div class="bracket-detail-panel" id="fedBracketPanel" style="display:none;">
      <div class="bracket-detail-header">
        <h3>üèõÔ∏è Federal Income Tax Brackets (2025 Single Filer)</h3>
        <button class="bracket-close" onclick="toggleBracketDetail('fed')">‚úï</button>
      </div>
      <div class="bracket-detail-body" id="fedBracketBody"></div>
    </div>
    <div class="bracket-detail-panel" id="stateBracketPanel" style="display:none;">
      <div class="bracket-detail-header">
        <h3 id="stateBracketTitle">üó∫Ô∏è State Income Tax Brackets</h3>
        <button class="bracket-close" onclick="toggleBracketDetail('state')">‚úï</button>
      </div>
      <div class="bracket-detail-body" id="stateBracketBody"></div>
    </div>

    <div class="charts-grid reveal">
      <div class="chart-card">
        <h2 id="fedChartTitle">Your Federal Tax Receipt</h2>
        <p class="chart-subtitle" id="fedChartSub"></p>
        <div class="chart-wrapper">
          <canvas id="fedChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h2 id="stateChartTitle">Your State Tax Receipt</h2>
        <p class="chart-subtitle" id="stateChartSub"></p>
        <div class="chart-wrapper" id="stateChartWrapper">
          <canvas id="stateChart"></canvas>
        </div>
        <div class="no-tax-note" id="noStateTaxNote" style="display:none;"></div>
      </div>
    </div>

    <div class="receipt-grid reveal">
      <div class="receipt-card">
        <div class="receipt-inner">
          <div class="receipt-header">
            <h3>üèõÔ∏è Federal Receipt</h3>
            <div class="receipt-date">Tax Year 2025 ¬∑ <a href="https://www.cbo.gov/topics/budget" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline;text-decoration-style:dotted;">IRS / CBO Data</a></div>
          </div>
          <div id="fedReceipt"></div>
          <div class="receipt-thankyou">‚òÖ Thank you, taxpayer ‚òÖ</div>
        </div>
      </div>
      <div class="receipt-card">
        <div class="receipt-inner">
          <div class="receipt-header">
            <h3 id="stateReceiptTitle">üó∫Ô∏è State Receipt</h3>
            <div class="receipt-date" id="stateReceiptDate">Tax Year 2025 ¬∑ Census Bureau FY2023 Data</div>
          </div>
          <div id="stateReceipt"></div>
          <div class="receipt-thankyou" id="stateReceiptThanks">‚òÖ Thank you, taxpayer ‚òÖ</div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê STATE VS STATE COMPARISON ‚ïê‚ïê‚ïê -->
    <div class="comparison-section reveal" id="comparisonSection" style="display:none;">
      <div class="section-label">COMPARE</div>
      <div class="chart-card" style="margin-bottom:28px;">
        <h2>State vs State Comparison</h2>
        <p class="chart-subtitle">Compare tax burdens and spending priorities between two states</p>
        <div class="compare-controls">
          <div class="compare-select-group">
            <label>State A</label>
            <select id="compareStateA"></select>
          </div>
          <div class="compare-vs">VS</div>
          <div class="compare-select-group">
            <label>State B</label>
            <select id="compareStateB"></select>
          </div>
        </div>
        <div class="compare-summary" id="compareSummary"></div>
        <div class="compare-chart-wrapper">
          <canvas id="compareChart"></canvas>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê YOU VS NATIONAL AVERAGE ‚ïê‚ïê‚ïê -->
    <div class="national-section reveal" id="nationalSection" style="display:none;">
      <div class="section-label">VS NATIONAL</div>
      <div class="chart-card" style="margin-bottom:28px;">
        <h2 id="nationalTitle">Your State vs National Average</h2>
        <p class="chart-subtitle" id="nationalSub">How your state's spending priorities compare to the national average</p>
        <div class="compare-chart-wrapper">
          <canvas id="nationalChart"></canvas>
        </div>
        <div id="nationalDeviations" class="deviation-list"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê STATE RANKINGS ‚ïê‚ïê‚ïê -->
    <div class="rankings-section reveal" id="rankingsSection" style="display:none;">
      <div class="section-label">RANKINGS</div>
      <div class="rankings-grid">
        <div class="chart-card ranking-card">
          <h3>üèõÔ∏è Tax Burden</h3>
          <p class="chart-subtitle">Effective rate rank among all states</p>
          <div class="rank-value" id="rankTaxValue"></div>
          <div class="rank-bar-container" id="rankTaxBar"></div>
        </div>
        <div class="chart-card ranking-card">
          <h3>üéì Education Spending</h3>
          <p class="chart-subtitle">K-12 + Higher Ed combined %</p>
          <div class="rank-value" id="rankEduValue"></div>
          <div class="rank-bar-container" id="rankEduBar"></div>
        </div>
        <div class="chart-card ranking-card">
          <h3>üè• Healthcare Spending</h3>
          <p class="chart-subtitle">Medicaid & Health %</p>
          <div class="rank-value" id="rankHealthValue"></div>
          <div class="rank-bar-container" id="rankHealthBar"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê TOTAL BUDGET BREAKDOWN ‚ïê‚ïê‚ïê -->
    <div class="budget-breakdown-section reveal" id="budgetBreakdownSection" style="display:none;">
      <div class="section-label">FULL PICTURE</div>
      <button class="budget-toggle-btn" id="budgetToggleBtn" onclick="toggleBudgetBreakdown()">
        <div class="budget-toggle-left">
          <div class="budget-toggle-hint">üí° Curious about the full picture?</div>
          <div class="budget-toggle-title">Total Budget Breakdown</div>
        </div>
        <span class="budget-toggle-arrow">‚Üí</span>
      </button>
      <div class="budget-collapse" id="budgetCollapse">
        <div class="budget-collapse-inner">
          <div class="budget-card">
            <h3>üèõÔ∏è Federal Budget (FY2025)</h3>
            <div class="budget-total-line" id="fedBudgetTotal"></div>
            <div id="fedBudgetBars"></div>
          </div>
          <div class="budget-card">
            <h3 id="stateBudgetTitle">üó∫Ô∏è State Budget</h3>
            <div class="budget-total-line" id="stateBudgetTotal"></div>
            <div id="stateBudgetBars"></div>
          </div>
        </div>
      </div>
    </div>

<!-- locality breakdown coming later -->
  </div>
</div>

<footer>
  <div class="footer-cta" id="footerCta" style="display:none;">
    <p>Know what your taxes buy? Share the knowledge.</p>
    <button class="share-btn" onclick="shareResults()">üìã Copy Link to Share</button>
  </div>
  <p class="fine-print">Data: IRS (2025 brackets), Tax Foundation, CBO/OMB (FY2025 est.), Census Bureau.<br>
  Single filer, standard deduction. Informational only ‚Äî not tax advice.<br>
  Built for free by <a href="https://ralcorn.com" target="_blank">Ralcorn Consulting</a></p>
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEDERAL 2025 TAX BRACKETS (Single Filer)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FEDERAL_STANDARD_DEDUCTION = 15000;
const FEDERAL_BRACKETS = [
  { min: 0,      max: 11925,   rate: 0.10 },
  { min: 11925,  max: 48475,   rate: 0.12 },
  { min: 48475,  max: 103350,  rate: 0.22 },
  { min: 103350, max: 197300,  rate: 0.24 },
  { min: 197300, max: 250525,  rate: 0.32 },
  { min: 250525, max: 626350,  rate: 0.35 },
  { min: 626350, max: Infinity, rate: 0.37 }
];

const FEDERAL_SPENDING = [
  { name: "Social Security",             pct: 21, color: "#6366f1" },
  { name: "Medicare",                    pct: 14, color: "#06b6d4" },
  { name: "Interest on Debt",            pct: 13, color: "#f43f5e" },
  { name: "National Defense",            pct: 13, color: "#64748b" },
  { name: "Medicaid & CHIP",             pct: 9,  color: "#10b981" },
  { name: "Income Security",             pct: 6,  color: "#f59e0b" },
  { name: "Veterans Benefits",           pct: 5,  color: "#8b5cf6" },
  { name: "Education",                   pct: 4,  color: "#ec4899" },
  { name: "Transportation",              pct: 2,  color: "#f97316" },
  { name: "Science & Technology",        pct: 1,  color: "#14b8a6" },
  { name: "International Affairs",       pct: 1,  color: "#a78bfa" },
  { name: "Other",                       pct: 11, color: "#475569" }
];

// State spending data: Census Bureau Annual Survey of State Government Finances, FY2023
// Source: usgovernmentspending.com (derived from Census Bureau data)
// Categories derived from Census functions: Education (split K-12/Higher Ed), Health Care,
// Welfare, Protection, Transportation, General Government, Other (Pensions+Interest+Misc)
const STATE_SPENDING_DEFAULT = [
  { name: "K-12 Education",              pct: 25, color: "#6366f1" },
  { name: "Medicaid & Health",           pct: 28, color: "#10b981" },
  { name: "Higher Education",            pct: 10, color: "#06b6d4" },
  { name: "Transportation",              pct: 8,  color: "#f97316" },
  { name: "Public Safety & Corrections", pct: 7,  color: "#64748b" },
  { name: "Public Assistance",           pct: 5,  color: "#f59e0b" },
  { name: "Government Admin",            pct: 5,  color: "#8b5cf6" },
  { name: "Other",                       pct: 12, color: "#475569" }
];

const STATE_SPENDING = {
  "Alabama": [
    { name: "K-12 Education", pct: 16, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 39, color: "#10b981" },
    { name: "Higher Education", pct: 11, color: "#06b6d4" },
    { name: "Transportation", pct: 6, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 4, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 17, color: "#475569" },
  ],
  "Alaska": [
    { name: "K-12 Education", pct: 7, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 27, color: "#10b981" },
    { name: "Higher Education", pct: 6, color: "#06b6d4" },
    { name: "Transportation", pct: 15, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 6, color: "#64748b" },
    { name: "Public Assistance", pct: 5, color: "#f59e0b" },
    { name: "Government Admin", pct: 7, color: "#8b5cf6" },
    { name: "Other", pct: 27, color: "#475569" },
  ],
  "Arizona": [
    { name: "K-12 Education", pct: 11, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 49, color: "#10b981" },
    { name: "Higher Education", pct: 9, color: "#06b6d4" },
    { name: "Transportation", pct: 4, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 8, color: "#f59e0b" },
    { name: "Government Admin", pct: 2, color: "#8b5cf6" },
    { name: "Other", pct: 13, color: "#475569" },
  ],
  "Arkansas": [
    { name: "K-12 Education", pct: 10, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 46, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 8, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 14, color: "#475569" },
  ],
  "California": [
    { name: "K-12 Education", pct: 10, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 43, color: "#10b981" },
    { name: "Higher Education", pct: 5, color: "#06b6d4" },
    { name: "Transportation", pct: 4, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 5, color: "#64748b" },
    { name: "Public Assistance", pct: 9, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 20, color: "#475569" },
  ],
  "Colorado": [
    { name: "K-12 Education", pct: 13, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 36, color: "#10b981" },
    { name: "Higher Education", pct: 10, color: "#06b6d4" },
    { name: "Transportation", pct: 5, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 5, color: "#8b5cf6" },
    { name: "Other", pct: 20, color: "#475569" },
  ],
  "Connecticut": [
    { name: "K-12 Education", pct: 10, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 24, color: "#10b981" },
    { name: "Higher Education", pct: 4, color: "#06b6d4" },
    { name: "Transportation", pct: 9, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 4, color: "#f59e0b" },
    { name: "Government Admin", pct: 6, color: "#8b5cf6" },
    { name: "Other", pct: 39, color: "#475569" },
  ],
  "Delaware": [
    { name: "K-12 Education", pct: 12, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 35, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 7, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 7, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 9, color: "#8b5cf6" },
    { name: "Other", pct: 15, color: "#475569" },
  ],
  "District of Columbia": [
    { name: "K-12 Education", pct: 13, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 6, color: "#10b981" },
    { name: "Higher Education", pct: 3, color: "#06b6d4" },
    { name: "Transportation", pct: 20, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 6, color: "#64748b" },
    { name: "Public Assistance", pct: 27, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 21, color: "#475569" },
  ],
  "Florida": [
    { name: "K-12 Education", pct: 10, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 37, color: "#10b981" },
    { name: "Higher Education", pct: 5, color: "#06b6d4" },
    { name: "Transportation", pct: 8, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 5, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 28, color: "#475569" },
  ],
  "Georgia": [
    { name: "K-12 Education", pct: 12, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 34, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 9, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 5, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 2, color: "#8b5cf6" },
    { name: "Other", pct: 24, color: "#475569" },
  ],
  "Hawaii": [
    { name: "K-12 Education", pct: 15, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 25, color: "#10b981" },
    { name: "Higher Education", pct: 15, color: "#06b6d4" },
    { name: "Transportation", pct: 7, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 2, color: "#64748b" },
    { name: "Public Assistance", pct: 5, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 28, color: "#475569" },
  ],
  "Idaho": [
    { name: "K-12 Education", pct: 10, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 32, color: "#10b981" },
    { name: "Higher Education", pct: 6, color: "#06b6d4" },
    { name: "Transportation", pct: 12, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 5, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 6, color: "#8b5cf6" },
    { name: "Other", pct: 22, color: "#475569" },
  ],
  "Illinois": [
    { name: "K-12 Education", pct: 9, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 37, color: "#10b981" },
    { name: "Higher Education", pct: 6, color: "#06b6d4" },
    { name: "Transportation", pct: 5, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 30, color: "#475569" },
  ],
  "Indiana": [
    { name: "K-12 Education", pct: 13, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 46, color: "#10b981" },
    { name: "Higher Education", pct: 9, color: "#06b6d4" },
    { name: "Transportation", pct: 7, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 9, color: "#f59e0b" },
    { name: "Government Admin", pct: 2, color: "#8b5cf6" },
    { name: "Other", pct: 11, color: "#475569" },
  ],
  "Iowa": [
    { name: "K-12 Education", pct: 8, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 47, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 8, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 16, color: "#475569" },
  ],
  "Kansas": [
    { name: "K-12 Education", pct: 9, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 46, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 8, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 17, color: "#475569" },
  ],
  "Kentucky": [
    { name: "K-12 Education", pct: 9, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 48, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 6, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 16, color: "#475569" },
  ],
  "Louisiana": [
    { name: "K-12 Education", pct: 8, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 41, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 6, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 25, color: "#475569" },
  ],
  "Maine": [
    { name: "K-12 Education", pct: 8, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 42, color: "#10b981" },
    { name: "Higher Education", pct: 5, color: "#06b6d4" },
    { name: "Transportation", pct: 7, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 10, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 21, color: "#475569" },
  ],
  "Maryland": [
    { name: "K-12 Education", pct: 10, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 39, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 9, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 6, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 5, color: "#8b5cf6" },
    { name: "Other", pct: 17, color: "#475569" },
  ],
  "Massachusetts": [
    { name: "K-12 Education", pct: 6, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 42, color: "#10b981" },
    { name: "Higher Education", pct: 5, color: "#06b6d4" },
    { name: "Transportation", pct: 10, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 12, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 18, color: "#475569" },
  ],
  "Michigan": [
    { name: "K-12 Education", pct: 12, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 42, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 4, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 20, color: "#475569" },
  ],
  "Minnesota": [
    { name: "K-12 Education", pct: 8, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 45, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 6, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 9, color: "#f59e0b" },
    { name: "Government Admin", pct: 5, color: "#8b5cf6" },
    { name: "Other", pct: 17, color: "#475569" },
  ],
  "Mississippi": [
    { name: "K-12 Education", pct: 9, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 42, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 6, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 24, color: "#475569" },
  ],
  "Missouri": [
    { name: "K-12 Education", pct: 7, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 47, color: "#10b981" },
    { name: "Higher Education", pct: 6, color: "#06b6d4" },
    { name: "Transportation", pct: 5, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 22, color: "#475569" },
  ],
  "Montana": [
    { name: "K-12 Education", pct: 8, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 35, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 10, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 7, color: "#8b5cf6" },
    { name: "Other", pct: 22, color: "#475569" },
  ],
  "Nebraska": [
    { name: "K-12 Education", pct: 11, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 39, color: "#10b981" },
    { name: "Higher Education", pct: 11, color: "#06b6d4" },
    { name: "Transportation", pct: 9, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 6, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 14, color: "#475569" },
  ],
  "Nevada": [
    { name: "K-12 Education", pct: 11, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 35, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 5, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 27, color: "#475569" },
  ],
  "New Hampshire": [
    { name: "K-12 Education", pct: 8, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 31, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 6, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 8, color: "#f59e0b" },
    { name: "Government Admin", pct: 11, color: "#8b5cf6" },
    { name: "Other", pct: 26, color: "#475569" },
  ],
  "New Jersey": [
    { name: "K-12 Education", pct: 12, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 32, color: "#10b981" },
    { name: "Higher Education", pct: 6, color: "#06b6d4" },
    { name: "Transportation", pct: 9, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 8, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 25, color: "#475569" },
  ],
  "New Mexico": [
    { name: "K-12 Education", pct: 8, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 50, color: "#10b981" },
    { name: "Higher Education", pct: 6, color: "#06b6d4" },
    { name: "Transportation", pct: 4, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 5, color: "#8b5cf6" },
    { name: "Other", pct: 18, color: "#475569" },
  ],
  "New York": [
    { name: "K-12 Education", pct: 5, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 46, color: "#10b981" },
    { name: "Higher Education", pct: 2, color: "#06b6d4" },
    { name: "Transportation", pct: 6, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 2, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 28, color: "#475569" },
  ],
  "North Carolina": [
    { name: "K-12 Education", pct: 12, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 37, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 11, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 5, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 7, color: "#8b5cf6" },
    { name: "Other", pct: 14, color: "#475569" },
  ],
  "North Dakota": [
    { name: "K-12 Education", pct: 9, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 30, color: "#10b981" },
    { name: "Higher Education", pct: 10, color: "#06b6d4" },
    { name: "Transportation", pct: 12, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 4, color: "#f59e0b" },
    { name: "Government Admin", pct: 5, color: "#8b5cf6" },
    { name: "Other", pct: 27, color: "#475569" },
  ],
  "Ohio": [
    { name: "K-12 Education", pct: 8, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 45, color: "#10b981" },
    { name: "Higher Education", pct: 5, color: "#06b6d4" },
    { name: "Transportation", pct: 4, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 26, color: "#475569" },
  ],
  "Oklahoma": [
    { name: "K-12 Education", pct: 10, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 41, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 10, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 17, color: "#475569" },
  ],
  "Oregon": [
    { name: "K-12 Education", pct: 8, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 44, color: "#10b981" },
    { name: "Higher Education", pct: 6, color: "#06b6d4" },
    { name: "Transportation", pct: 4, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 5, color: "#8b5cf6" },
    { name: "Other", pct: 22, color: "#475569" },
  ],
  "Pennsylvania": [
    { name: "K-12 Education", pct: 7, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 47, color: "#10b981" },
    { name: "Higher Education", pct: 5, color: "#06b6d4" },
    { name: "Transportation", pct: 8, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 18, color: "#475569" },
  ],
  "Rhode Island": [
    { name: "K-12 Education", pct: 7, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 38, color: "#10b981" },
    { name: "Higher Education", pct: 6, color: "#06b6d4" },
    { name: "Transportation", pct: 8, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 11, color: "#f59e0b" },
    { name: "Government Admin", pct: 8, color: "#8b5cf6" },
    { name: "Other", pct: 18, color: "#475569" },
  ],
  "South Carolina": [
    { name: "K-12 Education", pct: 12, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 37, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 7, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 5, color: "#f59e0b" },
    { name: "Government Admin", pct: 6, color: "#8b5cf6" },
    { name: "Other", pct: 22, color: "#475569" },
  ],
  "South Dakota": [
    { name: "K-12 Education", pct: 9, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 27, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 15, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 5, color: "#64748b" },
    { name: "Public Assistance", pct: 5, color: "#f59e0b" },
    { name: "Government Admin", pct: 7, color: "#8b5cf6" },
    { name: "Other", pct: 24, color: "#475569" },
  ],
  "Tennessee": [
    { name: "K-12 Education", pct: 10, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 43, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 7, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 7, color: "#f59e0b" },
    { name: "Government Admin", pct: 6, color: "#8b5cf6" },
    { name: "Other", pct: 16, color: "#475569" },
  ],
  "Texas": [
    { name: "K-12 Education", pct: 14, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 41, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 8, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 3, color: "#8b5cf6" },
    { name: "Other", pct: 17, color: "#475569" },
  ],
  "Utah": [
    { name: "K-12 Education", pct: 17, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 36, color: "#10b981" },
    { name: "Higher Education", pct: 12, color: "#06b6d4" },
    { name: "Transportation", pct: 6, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 3, color: "#64748b" },
    { name: "Public Assistance", pct: 4, color: "#f59e0b" },
    { name: "Government Admin", pct: 6, color: "#8b5cf6" },
    { name: "Other", pct: 16, color: "#475569" },
  ],
  "Vermont": [
    { name: "K-12 Education", pct: 11, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 38, color: "#10b981" },
    { name: "Higher Education", pct: 9, color: "#06b6d4" },
    { name: "Transportation", pct: 8, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 5, color: "#64748b" },
    { name: "Public Assistance", pct: 8, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 17, color: "#475569" },
  ],
  "Virginia": [
    { name: "K-12 Education", pct: 11, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 44, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 9, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 4, color: "#8b5cf6" },
    { name: "Other", pct: 15, color: "#475569" },
  ],
  "Washington": [
    { name: "K-12 Education", pct: 11, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 42, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 5, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 2, color: "#8b5cf6" },
    { name: "Other", pct: 22, color: "#475569" },
  ],
  "West Virginia": [
    { name: "K-12 Education", pct: 10, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 38, color: "#10b981" },
    { name: "Higher Education", pct: 8, color: "#06b6d4" },
    { name: "Transportation", pct: 11, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 5, color: "#8b5cf6" },
    { name: "Other", pct: 18, color: "#475569" },
  ],
  "Wisconsin": [
    { name: "K-12 Education", pct: 9, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 39, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 6, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 6, color: "#f59e0b" },
    { name: "Government Admin", pct: 8, color: "#8b5cf6" },
    { name: "Other", pct: 21, color: "#475569" },
  ],
  "Wyoming": [
    { name: "K-12 Education", pct: 7, color: "#6366f1" },
    { name: "Medicaid & Health", pct: 26, color: "#10b981" },
    { name: "Higher Education", pct: 7, color: "#06b6d4" },
    { name: "Transportation", pct: 13, color: "#f97316" },
    { name: "Public Safety & Corrections", pct: 4, color: "#64748b" },
    { name: "Public Assistance", pct: 4, color: "#f59e0b" },
    { name: "Government Admin", pct: 6, color: "#8b5cf6" },
    { name: "Other", pct: 33, color: "#475569" },
  ],
};

const STATE_SOURCES = {
  "Alabama": { name: "Alabama Executive Budget Office", url: "https://budget.alabama.gov" },
  "Alaska": { name: "Alaska Office of Management & Budget", url: "https://omb.alaska.gov" },
  "Arizona": { name: "Arizona OSPB", url: "https://ospb.az.gov" },
  "Arkansas": { name: "Arkansas Dept. of Finance & Administration", url: "https://www.dfa.arkansas.gov" },
  "California": { name: "California Department of Finance", url: "https://ebudget.ca.gov" },
  "Colorado": { name: "Colorado OSPB", url: "https://ospb.colorado.gov" },
  "Connecticut": { name: "Connecticut OPM", url: "https://portal.ct.gov/OPM/Budget" },
  "Delaware": { name: "Delaware Office of Management & Budget", url: "https://budget.delaware.gov" },
  "District of Columbia": { name: "DC Office of the CFO", url: "https://cfo.dc.gov/page/budget-documents" },
  "Florida": { name: "Florida Governor's Office", url: "https://www.flgov.com/budget" },
  "Georgia": { name: "Georgia OPB", url: "https://opb.georgia.gov" },
  "Hawaii": { name: "Hawaii Dept. of Budget & Finance", url: "https://budget.hawaii.gov" },
  "Idaho": { name: "Idaho Division of Financial Management", url: "https://dfm.idaho.gov" },
  "Illinois": { name: "Illinois Governor's Office of Management & Budget", url: "https://budget.illinois.gov" },
  "Indiana": { name: "Indiana State Budget Agency", url: "https://www.in.gov/sba" },
  "Iowa": { name: "Iowa Dept. of Management", url: "https://dom.iowa.gov" },
  "Kansas": { name: "Kansas Division of the Budget", url: "https://budget.kansas.gov" },
  "Kentucky": { name: "Kentucky OSBD", url: "https://osbd.ky.gov" },
  "Louisiana": { name: "Louisiana Office of Planning & Budget", url: "https://www.doa.la.gov/doa/opb" },
  "Maine": { name: "Maine Bureau of the Budget", url: "https://www.maine.gov/budget" },
  "Maryland": { name: "Maryland DBM", url: "https://dbm.maryland.gov" },
  "Massachusetts": { name: "Massachusetts Executive Office for A&F", url: "https://budget.digital.mass.gov" },
  "Michigan": { name: "Michigan State Budget Office", url: "https://www.michigan.gov/budget" },
  "Minnesota": { name: "Minnesota Management & Budget", url: "https://mn.gov/mmb/budget" },
  "Mississippi": { name: "Mississippi Joint Legislative Budget Committee", url: "https://www.mississippi.edu/research/budget.asp" },
  "Missouri": { name: "Missouri Office of Administration", url: "https://oa.mo.gov/budget-and-planning" },
  "Montana": { name: "Montana Budget & Accounting", url: "https://budget.mt.gov" },
  "Nebraska": { name: "Nebraska DAS Budget Division", url: "https://das.nebraska.gov/budget" },
  "Nevada": { name: "Nevada Governor's Finance Office", url: "https://budget.nv.gov" },
  "New Hampshire": { name: "New Hampshire DAS Budget", url: "https://das.nh.gov/budget" },
  "New Jersey": { name: "New Jersey Office of Management & Budget", url: "https://www.nj.gov/treasury/omb" },
  "New Mexico": { name: "New Mexico DFA", url: "https://www.nmdfa.state.nm.us" },
  "New York": { name: "New York Division of the Budget", url: "https://www.budget.ny.gov" },
  "North Carolina": { name: "North Carolina OSBM", url: "https://www.osbm.nc.gov" },
  "North Dakota": { name: "North Dakota OMB", url: "https://www.nd.gov/omb" },
  "Ohio": { name: "Ohio Office of Budget & Management", url: "https://obm.ohio.gov" },
  "Oklahoma": { name: "Oklahoma OMES", url: "https://omes.ok.gov/budget" },
  "Oregon": { name: "Oregon DAS Budget", url: "https://www.oregon.gov/das/Financial/Pages/Budget.aspx" },
  "Pennsylvania": { name: "Pennsylvania Governor's Budget Office", url: "https://www.budget.pa.gov" },
  "Rhode Island": { name: "Rhode Island OMB", url: "https://www.omb.ri.gov" },
  "South Carolina": { name: "South Carolina Governor's Office", url: "https://governor.sc.gov/executive-budget" },
  "South Dakota": { name: "South Dakota Bureau of Finance & Management", url: "https://bfm.sd.gov" },
  "Tennessee": { name: "Tennessee Dept. of Finance & Administration", url: "https://www.tn.gov/finance/fa/fa-budget-information.html" },
  "Texas": { name: "Texas Legislative Budget Board", url: "https://www.lbb.texas.gov" },
  "Utah": { name: "Utah Governor's Office of Planning & Budget", url: "https://gopb.utah.gov" },
  "Vermont": { name: "Vermont Dept. of Finance & Management", url: "https://finance.vermont.gov" },
  "Virginia": { name: "Virginia Dept. of Planning & Budget", url: "https://dpb.virginia.gov" },
  "Washington": { name: "Washington OFM", url: "https://ofm.wa.gov/budget" },
  "West Virginia": { name: "West Virginia State Budget Office", url: "https://budget.wv.gov" },
  "Wisconsin": { name: "Wisconsin DOA State Finances", url: "https://doa.wi.gov/Pages/StateFinances/CurrentBiennialBudget.aspx" },
  "Wyoming": { name: "Wyoming Budget Division", url: "https://ai.wyo.gov/budget-division" },
  "_default": { name: "U.S. Census Bureau", url: "https://www.census.gov/programs-surveys/state.html" }
};

// ‚ïê‚ïê‚ïê STATE BUDGET TOTALS (FY2023 Census estimates, in billions) ‚ïê‚ïê‚ïê
const FEDERAL_BUDGET_TOTAL = 6750; // $6.75 trillion in billions
const STATE_BUDGET_TOTALS = {
  "Alabama": 55, "Alaska": 16, "Arizona": 75, "Arkansas": 35, "California": 560,
  "Colorado": 65, "Connecticut": 55, "Delaware": 14, "District of Columbia": 20,
  "Florida": 215, "Georgia": 115, "Hawaii": 22, "Idaho": 18, "Illinois": 165,
  "Indiana": 70, "Iowa": 40, "Kansas": 30, "Kentucky": 50, "Louisiana": 60,
  "Maine": 18, "Maryland": 95, "Massachusetts": 110, "Michigan": 105, "Minnesota": 85,
  "Mississippi": 35, "Missouri": 60, "Montana": 14, "Nebraska": 20, "Nevada": 30,
  "New Hampshire": 15, "New Jersey": 120, "New Mexico": 30, "New York": 360,
  "North Carolina": 110, "North Dakota": 12, "Ohio": 160, "Oklahoma": 40,
  "Oregon": 65, "Pennsylvania": 175, "Rhode Island": 16, "South Carolina": 55,
  "South Dakota": 10, "Tennessee": 65, "Texas": 290, "Utah": 40, "Vermont": 10,
  "Virginia": 115, "Washington": 115, "West Virginia": 20, "Wisconsin": 70, "Wyoming": 8
};

function formatBudget(amountInBillions) {
  if (amountInBillions >= 1000) return '$' + (amountInBillions / 1000).toFixed(2).replace(/\.?0+$/, '') + 'T';
  if (amountInBillions >= 1) return '$' + amountInBillions.toFixed(1).replace(/\.0$/, '') + 'B';
  return '$' + Math.round(amountInBillions * 1000) + 'M';
}

function toggleBudgetBreakdown() {
  const btn = document.getElementById('budgetToggleBtn');
  const collapse = document.getElementById('budgetCollapse');
  btn.classList.toggle('open');
  collapse.classList.toggle('open');
}

function updateBudgetBreakdown(stateName) {
  // Federal
  document.getElementById('fedBudgetTotal').textContent = 'Total: ~$6.75 Trillion (CBO FY2025 Estimate)';
  let fedHTML = '';
  const fedMax = Math.max(...FEDERAL_SPENDING.map(s => s.pct));
  FEDERAL_SPENDING.forEach(s => {
    const amt = (s.pct / 100) * FEDERAL_BUDGET_TOTAL;
    const widthPct = (s.pct / fedMax) * 100;
    fedHTML += `<div class="budget-bar-row">
      <span class="budget-bar-label">${s.name}</span>
      <div class="budget-bar-track"><div class="budget-bar-fill" style="width:${widthPct}%;background:${s.color};"></div></div>
      <span class="budget-bar-amount">${formatBudget(amt)}</span>
    </div>`;
  });
  document.getElementById('fedBudgetBars').innerHTML = fedHTML;

  // State
  const stateTotal = STATE_BUDGET_TOTALS[stateName];
  document.getElementById('stateBudgetTitle').textContent = 'üó∫Ô∏è ' + stateName + ' Budget';
  if (!stateTotal) {
    document.getElementById('stateBudgetTotal').textContent = 'Budget data not available for ' + stateName;
    document.getElementById('stateBudgetBars').innerHTML = '';
    return;
  }
  document.getElementById('stateBudgetTotal').textContent = 'Total: ~' + formatBudget(stateTotal) + ' (FY2023 Census Estimate)';
  const stateSpending = STATE_SPENDING[stateName] || STATE_SPENDING_DEFAULT;
  const stateMax = Math.max(...stateSpending.map(s => s.pct));
  let stateHTML = '';
  stateSpending.forEach(s => {
    const amt = (s.pct / 100) * stateTotal;
    const widthPct = (s.pct / stateMax) * 100;
    stateHTML += `<div class="budget-bar-row">
      <span class="budget-bar-label">${s.name}</span>
      <div class="budget-bar-track"><div class="budget-bar-fill" style="width:${widthPct}%;background:${s.color};"></div></div>
      <span class="budget-bar-amount">${formatBudget(amt)}</span>
    </div>`;
  });
  document.getElementById('stateBudgetBars').innerHTML = stateHTML;
}

const STATE_TAX = {
  "Alabama": {
    deduction: 3000,
    brackets: [
      { min: 0, max: 500, rate: 0.02 },
      { min: 500, max: 3000, rate: 0.04 },
      { min: 3000, max: Infinity, rate: 0.05 }
    ]
  },
  "Alaska": { noTax: true },
  "Arizona": {
    deduction: 15000,
    brackets: [
      { min: 0, max: Infinity, rate: 0.025 }
    ]
  },
  "Arkansas": {
    deduction: 2410,
    brackets: [
      { min: 0, max: 4500, rate: 0.02 },
      { min: 4500, max: Infinity, rate: 0.039 }
    ]
  },
  "California": {
    deduction: 5540,
    brackets: [
      { min: 0,      max: 10756,   rate: 0.01 },
      { min: 10756,  max: 25499,   rate: 0.02 },
      { min: 25499,  max: 40245,   rate: 0.04 },
      { min: 40245,  max: 55866,   rate: 0.06 },
      { min: 55866,  max: 70606,   rate: 0.08 },
      { min: 70606,  max: 360659,  rate: 0.093 },
      { min: 360659, max: 432787,  rate: 0.103 },
      { min: 432787, max: 721314,  rate: 0.113 },
      { min: 721314, max: 1000000, rate: 0.123 },
      { min: 1000000, max: Infinity, rate: 0.133 }
    ]
  },
  "Colorado": {
    deduction: 15000,
    brackets: [
      { min: 0, max: Infinity, rate: 0.044 }
    ]
  },
  "Connecticut": {
    deduction: 0,
    exemption: 15000,
    brackets: [
      { min: 0,      max: 10000,  rate: 0.02 },
      { min: 10000,  max: 50000,  rate: 0.045 },
      { min: 50000,  max: 100000, rate: 0.055 },
      { min: 100000, max: 200000, rate: 0.06 },
      { min: 200000, max: 250000, rate: 0.065 },
      { min: 250000, max: 500000, rate: 0.069 },
      { min: 500000, max: Infinity, rate: 0.0699 }
    ]
  },
  "Delaware": {
    deduction: 3250,
    brackets: [
      { min: 0,     max: 2000,  rate: 0.00 },
      { min: 2000,  max: 5000,  rate: 0.022 },
      { min: 5000,  max: 10000, rate: 0.039 },
      { min: 10000, max: 20000, rate: 0.048 },
      { min: 20000, max: 25000, rate: 0.052 },
      { min: 25000, max: 60000, rate: 0.0555 },
      { min: 60000, max: Infinity, rate: 0.066 }
    ]
  },
  "Florida": { noTax: true },
  "Georgia": {
    deduction: 12000,
    brackets: [
      { min: 0, max: Infinity, rate: 0.0539 }
    ]
  },
  "Hawaii": {
    deduction: 4400,
    brackets: [
      { min: 0,      max: 9600,   rate: 0.014 },
      { min: 9600,   max: 14400,  rate: 0.032 },
      { min: 14400,  max: 19200,  rate: 0.055 },
      { min: 19200,  max: 24000,  rate: 0.064 },
      { min: 24000,  max: 36000,  rate: 0.068 },
      { min: 36000,  max: 48000,  rate: 0.072 },
      { min: 48000,  max: 125000, rate: 0.076 },
      { min: 125000, max: 175000, rate: 0.079 },
      { min: 175000, max: 225000, rate: 0.0825 },
      { min: 225000, max: 275000, rate: 0.09 },
      { min: 275000, max: 325000, rate: 0.10 },
      { min: 325000, max: Infinity, rate: 0.11 }
    ]
  },
  "Idaho": {
    deduction: 15000,
    brackets: [
      { min: 0,    max: 4673, rate: 0.00 },
      { min: 4673, max: Infinity, rate: 0.05695 }
    ]
  },
  "Illinois": {
    deduction: 0,
    exemption: 2850,
    brackets: [
      { min: 0, max: Infinity, rate: 0.0495 }
    ]
  },
  "Indiana": {
    deduction: 0,
    exemption: 1000,
    brackets: [
      { min: 0, max: Infinity, rate: 0.03 }
    ]
  },
  "Iowa": {
    deduction: 0,
    brackets: [
      { min: 0, max: Infinity, rate: 0.038 }
    ]
  },
  "Kansas": {
    deduction: 3605,
    exemption: 9160,
    brackets: [
      { min: 0,     max: 23000, rate: 0.052 },
      { min: 23000, max: Infinity, rate: 0.0558 }
    ]
  },
  "Kentucky": {
    deduction: 3270,
    brackets: [
      { min: 0, max: Infinity, rate: 0.04 }
    ]
  },
  "Louisiana": {
    deduction: 12500,
    brackets: [
      { min: 0, max: Infinity, rate: 0.03 }
    ]
  },
  "Maine": {
    deduction: 15000,
    exemption: 5150,
    brackets: [
      { min: 0,     max: 26800, rate: 0.058 },
      { min: 26800, max: 63450, rate: 0.0675 },
      { min: 63450, max: Infinity, rate: 0.0715 }
    ]
  },
  "Maryland": {
    deduction: 2700,
    exemption: 3200,
    brackets: [
      { min: 0,      max: 1000,   rate: 0.02 },
      { min: 1000,   max: 2000,   rate: 0.03 },
      { min: 2000,   max: 3000,   rate: 0.04 },
      { min: 3000,   max: 100000, rate: 0.0475 },
      { min: 100000, max: 125000, rate: 0.05 },
      { min: 125000, max: 150000, rate: 0.0525 },
      { min: 150000, max: 250000, rate: 0.055 },
      { min: 250000, max: Infinity, rate: 0.0575 }
    ]
  },
  "Massachusetts": {
    deduction: 0,
    exemption: 4400,
    brackets: [
      { min: 0,       max: 1000000, rate: 0.05 },
      { min: 1000000, max: Infinity, rate: 0.09 }
    ]
  },
  "Michigan": {
    deduction: 0,
    exemption: 5800,
    brackets: [
      { min: 0, max: Infinity, rate: 0.0425 }
    ]
  },
  "Minnesota": {
    deduction: 14950,
    brackets: [
      { min: 0,      max: 32570,  rate: 0.0535 },
      { min: 32570,  max: 106990, rate: 0.068 },
      { min: 106990, max: 198630, rate: 0.0785 },
      { min: 198630, max: Infinity, rate: 0.0985 }
    ]
  },
  "Mississippi": {
    deduction: 2300,
    exemption: 6000,
    brackets: [
      { min: 0,     max: 10000, rate: 0.00 },
      { min: 10000, max: Infinity, rate: 0.044 }
    ]
  },
  "Missouri": {
    deduction: 15000,
    brackets: [
      { min: 0,    max: 1313, rate: 0.00 },
      { min: 1313, max: 2626, rate: 0.02 },
      { min: 2626, max: 3939, rate: 0.025 },
      { min: 3939, max: 5252, rate: 0.03 },
      { min: 5252, max: 6565, rate: 0.035 },
      { min: 6565, max: 7878, rate: 0.04 },
      { min: 7878, max: 9191, rate: 0.045 },
      { min: 9191, max: Infinity, rate: 0.047 }
    ]
  },
  "Montana": {
    deduction: 15000,
    brackets: [
      { min: 0,     max: 21100, rate: 0.047 },
      { min: 21100, max: Infinity, rate: 0.059 }
    ]
  },
  "Nebraska": {
    deduction: 8600,
    brackets: [
      { min: 0,     max: 4030,  rate: 0.0246 },
      { min: 4030,  max: 24120, rate: 0.0351 },
      { min: 24120, max: 38870, rate: 0.0501 },
      { min: 38870, max: Infinity, rate: 0.052 }
    ]
  },
  "Nevada": { noTax: true },
  "New Hampshire": { noTax: true },
  "New Jersey": {
    deduction: 0,
    exemption: 1000,
    brackets: [
      { min: 0,       max: 20000,   rate: 0.014 },
      { min: 20000,   max: 35000,   rate: 0.0175 },
      { min: 35000,   max: 40000,   rate: 0.035 },
      { min: 40000,   max: 75000,   rate: 0.05525 },
      { min: 75000,   max: 500000,  rate: 0.0637 },
      { min: 500000,  max: 1000000, rate: 0.0897 },
      { min: 1000000, max: Infinity, rate: 0.1075 }
    ]
  },
  "New Mexico": {
    deduction: 15000,
    brackets: [
      { min: 0,      max: 5500,   rate: 0.015 },
      { min: 5500,   max: 16500,  rate: 0.032 },
      { min: 16500,  max: 33500,  rate: 0.043 },
      { min: 33500,  max: 66500,  rate: 0.047 },
      { min: 66500,  max: 210000, rate: 0.049 },
      { min: 210000, max: Infinity, rate: 0.059 }
    ]
  },
  "New York": {
    deduction: 8000,
    brackets: [
      { min: 0,        max: 8500,     rate: 0.04 },
      { min: 8500,     max: 11700,    rate: 0.045 },
      { min: 11700,    max: 13900,    rate: 0.0525 },
      { min: 13900,    max: 80650,    rate: 0.055 },
      { min: 80650,    max: 215400,   rate: 0.06 },
      { min: 215400,   max: 1077550,  rate: 0.0685 },
      { min: 1077550,  max: 5000000,  rate: 0.0965 },
      { min: 5000000,  max: 25000000, rate: 0.103 },
      { min: 25000000, max: Infinity,  rate: 0.109 }
    ]
  },
  "North Carolina": {
    deduction: 12750,
    brackets: [
      { min: 0, max: Infinity, rate: 0.0425 }
    ]
  },
  "North Dakota": {
    deduction: 15000,
    brackets: [
      { min: 0,      max: 48475,  rate: 0.00 },
      { min: 48475,  max: 244825, rate: 0.0195 },
      { min: 244825, max: Infinity, rate: 0.025 }
    ]
  },
  "Ohio": {
    deduction: 0,
    brackets: [
      { min: 0,      max: 26050,  rate: 0.00 },
      { min: 26050,  max: 100000, rate: 0.0275 },
      { min: 100000, max: Infinity, rate: 0.035 }
    ]
  },
  "Oklahoma": {
    deduction: 6350,
    exemption: 1000,
    brackets: [
      { min: 0,    max: 1000, rate: 0.0025 },
      { min: 1000, max: 2500, rate: 0.0075 },
      { min: 2500, max: 3750, rate: 0.0175 },
      { min: 3750, max: 4900, rate: 0.0275 },
      { min: 4900, max: 7200, rate: 0.0375 },
      { min: 7200, max: Infinity, rate: 0.0475 }
    ]
  },
  "Oregon": {
    deduction: 2800,
    brackets: [
      { min: 0,      max: 4400,   rate: 0.0475 },
      { min: 4400,   max: 11050,  rate: 0.0675 },
      { min: 11050,  max: 125000, rate: 0.0875 },
      { min: 125000, max: Infinity, rate: 0.099 }
    ]
  },
  "Pennsylvania": {
    deduction: 0,
    brackets: [
      { min: 0, max: Infinity, rate: 0.0307 }
    ]
  },
  "Rhode Island": {
    deduction: 10900,
    exemption: 5100,
    brackets: [
      { min: 0,      max: 79900,  rate: 0.0375 },
      { min: 79900,  max: 181650, rate: 0.0475 },
      { min: 181650, max: Infinity, rate: 0.0599 }
    ]
  },
  "South Carolina": {
    deduction: 15000,
    brackets: [
      { min: 0,     max: 3560,  rate: 0.00 },
      { min: 3560,  max: 17830, rate: 0.03 },
      { min: 17830, max: Infinity, rate: 0.062 }
    ]
  },
  "South Dakota": { noTax: true },
  "Tennessee": { noTax: true },
  "Texas": { noTax: true },
  "Utah": {
    deduction: 0,
    brackets: [
      { min: 0, max: Infinity, rate: 0.0455 }
    ]
  },
  "Vermont": {
    deduction: 7400,
    exemption: 5100,
    brackets: [
      { min: 0,      max: 47900,  rate: 0.0335 },
      { min: 47900,  max: 116000, rate: 0.066 },
      { min: 116000, max: 242000, rate: 0.076 },
      { min: 242000, max: Infinity, rate: 0.0875 }
    ]
  },
  "Virginia": {
    deduction: 8500,
    exemption: 930,
    brackets: [
      { min: 0,     max: 3000,  rate: 0.02 },
      { min: 3000,  max: 5000,  rate: 0.03 },
      { min: 5000,  max: 17000, rate: 0.05 },
      { min: 17000, max: Infinity, rate: 0.0575 }
    ]
  },
  "Washington": { noTax: true, note: "Washington has no income tax on wages. A 7% tax on capital gains over $270,000 applies separately." },
  "West Virginia": {
    deduction: 0,
    exemption: 2000,
    brackets: [
      { min: 0,     max: 10000, rate: 0.0222 },
      { min: 10000, max: 25000, rate: 0.0296 },
      { min: 25000, max: 40000, rate: 0.0333 },
      { min: 40000, max: 60000, rate: 0.0444 },
      { min: 60000, max: Infinity, rate: 0.0482 }
    ]
  },
  "Wisconsin": {
    deduction: 13560,
    brackets: [
      { min: 0,      max: 14680,  rate: 0.035 },
      { min: 14680,  max: 29370,  rate: 0.044 },
      { min: 29370,  max: 323290, rate: 0.053 },
      { min: 323290, max: Infinity, rate: 0.0765 }
    ]
  },
  "Wyoming": { noTax: true },
  "District of Columbia": {
    deduction: 15000,
    brackets: [
      { min: 0,       max: 10000,   rate: 0.04 },
      { min: 10000,   max: 40000,   rate: 0.06 },
      { min: 40000,   max: 60000,   rate: 0.065 },
      { min: 60000,   max: 250000,  rate: 0.085 },
      { min: 250000,  max: 500000,  rate: 0.0925 },
      { min: 500000,  max: 1000000, rate: 0.0975 },
      { min: 1000000, max: Infinity, rate: 0.1075 }
    ]
  }
};

const NO_TAX_STATES = ["Alaska","Florida","Nevada","New Hampshire","South Dakota","Tennessee","Texas","Washington","Wyoming"];

// ‚ïê‚ïê‚ïê POPULATE STATE DROPDOWN ‚ïê‚ïê‚ïê
const stateSelect = document.getElementById('state');
Object.keys(STATE_TAX).sort().forEach(s => {
  const opt = document.createElement('option');
  opt.value = s;
  opt.textContent = s;
  if (s === 'Virginia') opt.selected = true;
  stateSelect.appendChild(opt);
});

// ‚ïê‚ïê‚ïê INCOME INPUT FORMATTING ‚ïê‚ïê‚ïê
const incomeInput = document.getElementById('income');
incomeInput.addEventListener('input', function() {
  let raw = this.value.replace(/[^0-9]/g, '');
  if (raw.length > 12) raw = raw.slice(0, 12);
  if (raw) this.value = Number(raw).toLocaleString('en-US');
});
incomeInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') calculate();
});

// ‚ïê‚ïê‚ïê SCROLL REVEAL ‚ïê‚ïê‚ïê
const revealObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      entry.target.classList.add('visible');
    }
  });
}, { threshold: 0.1 });

// ‚ïê‚ïê‚ïê COUNT-UP ANIMATION ‚ïê‚ïê‚ïê
function animateValue(el, target, prefix = '', suffix = '', duration = 800) {
  const start = 0;
  const startTime = performance.now();
  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    const current = Math.round(start + (target - start) * eased);
    el.textContent = prefix + current.toLocaleString('en-US') + suffix;
    if (progress < 1) requestAnimationFrame(update);
  }
  requestAnimationFrame(update);
}

// ‚ïê‚ïê‚ïê BRACKET HELPERS ‚ïê‚ïê‚ïê
function fmtRate(rate) {
  // Show exact percentage with no unnecessary trailing zeros
  // rate is decimal (e.g. 0.0575 -> "5.75%")
  const pct = rate * 100;
  // Use up to 3 decimal places, strip trailing zeros
  let s = pct.toFixed(3).replace(/\.?0+$/, '');
  return s + '%';
}

function getMarginalRate(taxableIncome, brackets) {
  let marginal = brackets[0].rate;
  for (const b of brackets) {
    if (taxableIncome > b.min) marginal = b.rate;
  }
  return marginal;
}

function buildBracketPanel(type, brackets, taxableIncome, totalTax, effRate, grossIncome, label) {
  const body = document.getElementById(type + 'BracketBody');
  let html = '<div class="bracket-row bracket-header"><span>Income Range</span><span style="text-align:center;">Rate</span><span>Your Income in Bracket</span><span style="text-align:right;">Tax Owed</span></div>';
  const maxTaxInBracket = Math.max(...brackets.map(b => {
    const inBracket = Math.max(0, Math.min(taxableIncome, b.max) - b.min);
    return inBracket * b.rate;
  }));

  brackets.forEach((b, i) => {
    const inBracket = Math.max(0, Math.min(taxableIncome, b.max) - b.min);
    const taxInBracket = inBracket * b.rate;
    const isActive = taxableIncome > b.min && (i === brackets.length - 1 || taxableIncome <= brackets[i].max || taxableIncome > b.min);
    const isCurrentBracket = taxableIncome > b.min && (b.max === Infinity || taxableIncome <= b.max);
    const rangeText = b.max === Infinity ? fmtDollar(b.min) + '+' : fmtDollar(b.min) + ' - ' + fmtDollar(b.max);
    const barWidth = maxTaxInBracket > 0 ? (taxInBracket / maxTaxInBracket * 100) : 0;

    html += `<div class="bracket-row ${isCurrentBracket ? 'bracket-active' : ''}" style="${inBracket === 0 ? 'opacity:0.4;' : ''}">
      <span class="bracket-range">${rangeText}</span>
      <span class="bracket-rate">${fmtRate(b.rate)}</span>
      <span>${inBracket > 0 ? fmtDollar(inBracket) : '‚Äî'}</span>
      <span class="bracket-tax">${inBracket > 0 ? fmtDollar(taxInBracket) : '‚Äî'}</span>
    </div>`;
  });

  html += `<div class="bracket-total-row"><span>Total ${label} Tax</span><span>${fmtDollar(totalTax)}</span></div>`;
  html += `<div class="bracket-effective">Effective rate: ${effRate.toFixed(2)}% of ${fmtDollar(grossIncome)} gross income</div>`;
  body.innerHTML = html;
}

function toggleBracketDetail(type) {
  const panel = document.getElementById(type + 'BracketPanel');
  if (!panel) return;
  const isHidden = panel.style.display === 'none';
  panel.style.display = isHidden ? '' : 'none';
  if (isHidden) panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ‚ïê‚ïê‚ïê TAX CALCULATION ‚ïê‚ïê‚ïê
function calcBracketTax(income, brackets) {
  let tax = 0;
  for (const b of brackets) {
    if (income <= b.min) break;
    tax += (Math.min(income, b.max) - b.min) * b.rate;
  }
  return Math.max(0, tax);
}

function calcFederalTax(grossIncome) {
  return calcBracketTax(Math.max(0, grossIncome - FEDERAL_STANDARD_DEDUCTION), FEDERAL_BRACKETS);
}

function calcStateTax(grossIncome, stateName) {
  const d = STATE_TAX[stateName];
  if (!d || d.noTax) return 0;
  return calcBracketTax(Math.max(0, grossIncome - (d.deduction || 0) - (d.exemption || 0)), d.brackets);
}

function fmtDollar(n) {
  if (n >= 1) return '$' + Math.round(n).toLocaleString('en-US');
  if (n > 0) return '$' + n.toFixed(2);
  return '$0';
}

// ‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê
let fedChartInstance = null;
let stateChartInstance = null;

function createPieChart(canvasId, labels, data, colors, centerText, centerSub) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  const centerPlugin = {
    id: 'centerText',
    afterDraw(chart) {
      const {ctx: c, chartArea: {top, bottom, left, right}} = chart;
      const cx = (left + right) / 2;
      const cy = (top + bottom) / 2;
      c.save();
      c.textAlign = 'center';
      c.textBaseline = 'middle';
      c.font = "800 1.3rem 'Inter', sans-serif";
      c.fillStyle = '#1a2332';
      c.fillText(centerText || '', cx, cy - 8);
      c.font = "500 0.65rem 'Inter', sans-serif";
      c.fillStyle = '#94a3b8';
      c.letterSpacing = '0.08em';
      c.fillText((centerSub || '').toUpperCase(), cx, cy + 14);
      c.restore();
    }
  };
  return new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors,
        borderWidth: 0,
        hoverBorderWidth: 2,
        hoverBorderColor: '#fff',
        hoverOffset: 10
      }]
    },
    plugins: [centerPlugin],
    options: {
      responsive: true,
      maintainAspectRatio: true,
      cutout: '55%',
      animation: { animateRotate: true, duration: 1200, easing: 'easeOutQuart' },
      plugins: {
        legend: {
          position: 'bottom',
          align: 'start',
          labels: {
            padding: 12,
            usePointStyle: true,
            pointStyleWidth: 10,
            color: '#334155',
            font: { family: "'Inter', sans-serif", size: 11.5 },
            generateLabels(chart) {
              return chart.data.labels.map((label, i) => ({
                text: label + ' ¬∑ ' + fmtDollar(chart.data.datasets[0].data[i]),
                fillStyle: chart.data.datasets[0].backgroundColor[i],
                strokeStyle: 'transparent',
                lineWidth: 0,
                pointStyle: 'rectRounded',
                index: i,
                hidden: false
              }));
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(255,255,255,0.95)',
          borderColor: 'rgba(0,0,0,0.1)',
          borderWidth: 1,
          titleColor: '#1a2332',
          bodyColor: '#5a6a7e',
          cornerRadius: 8,
          padding: 12,
          callbacks: {
            label(ctx) {
              const total = ctx.dataset.data.reduce((a,b) => a+b, 0);
              return ctx.label + ': ' + fmtDollar(ctx.raw) + ' (' + ((ctx.raw/total)*100).toFixed(2) + '%)';
            }
          },
          bodyFont: { family: "'Inter', sans-serif" },
          titleFont: { family: "'Inter', sans-serif" }
        }
      }
    }
  });
}

// ‚ïê‚ïê‚ïê SHARE ‚ïê‚ïê‚ïê
function shareResults() {
  navigator.clipboard.writeText(window.location.href).then(() => {
    const btn = document.querySelector('.share-btn');
    btn.textContent = '‚úì Link Copied!';
    setTimeout(() => { btn.innerHTML = 'üìã Copy Link to Share'; }, 2000);
  });
}

// ‚ïê‚ïê‚ïê MAIN CALCULATE ‚ïê‚ïê‚ïê
function calculate() {
  const rawIncome = incomeInput.value.replace(/[^0-9]/g, '');
  const income = parseInt(rawIncome, 10);
  const stateName = stateSelect.value;

  if (!rawIncome || isNaN(income) || income <= 0) {
    incomeInput.style.borderColor = '#f43f5e';
    incomeInput.style.boxShadow = '0 0 0 3px rgba(244,63,94,0.2)';
    incomeInput.focus();
    setTimeout(() => { incomeInput.style.borderColor = ''; incomeInput.style.boxShadow = ''; }, 2000);
    return;
  }

  const fedTax = calcFederalTax(income);
  const stateTax = calcStateTax(income, stateName);
  const totalTax = fedTax + stateTax;
  const fedEffRate = income > 0 ? ((fedTax / income) * 100) : 0;
  const stateEffRate = income > 0 ? ((stateTax / income) * 100) : 0;

  // Get marginal rates
  const fedTaxableIncome = Math.max(0, income - FEDERAL_STANDARD_DEDUCTION);
  const fedMarginal = getMarginalRate(fedTaxableIncome, FEDERAL_BRACKETS);
  const stateData = STATE_TAX[stateName];
  let stateMarginal = 0;
  if (stateData && !stateData.noTax) {
    const stateTaxableIncome = Math.max(0, income - (stateData.deduction || 0) - (stateData.exemption || 0));
    stateMarginal = getMarginalRate(stateTaxableIncome, stateData.brackets);
  }

  // Animate summary values
  animateValue(document.getElementById('sumIncome'), income, '$');
  animateValue(document.getElementById('sumFederal'), Math.round(fedTax), '$');
  animateValue(document.getElementById('sumState'), Math.round(stateTax), '$');

  // Show marginal rate as main value, effective as subtitle
  document.getElementById('sumFedRate').textContent = fmtRate(fedMarginal);
  document.getElementById('sumFedRateSub').textContent = fedEffRate.toFixed(2) + '% effective';

  if (stateData && stateData.noTax) {
    document.getElementById('sumStateRate').textContent = '0%';
    document.getElementById('sumStateRateSub').textContent = 'No income tax';
  } else {
    document.getElementById('sumStateRate').textContent = fmtRate(stateMarginal);
    document.getElementById('sumStateRateSub').textContent = stateEffRate.toFixed(2) + '% effective';
  }

  // Build bracket detail panels
  buildBracketPanel('fed', FEDERAL_BRACKETS, fedTaxableIncome, fedTax, fedEffRate, income, 'Federal');
  if (stateData && !stateData.noTax) {
    const sTI = Math.max(0, income - (stateData.deduction || 0) - (stateData.exemption || 0));
    buildBracketPanel('state', stateData.brackets, sTI, stateTax, stateEffRate, income, stateName);
    document.getElementById('stateBracketTitle').textContent = 'üó∫Ô∏è ' + stateName + ' Income Tax Brackets (2025 Single Filer)';
  } else {
    document.getElementById('stateBracketBody').innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted);font-style:italic;">No state income tax brackets to display.</div>';
    document.getElementById('stateBracketTitle').textContent = 'üó∫Ô∏è ' + stateName + ' Income Tax Brackets';
  }

  // Hide panels on recalculate
  document.getElementById('fedBracketPanel').style.display = 'none';
  document.getElementById('stateBracketPanel').style.display = 'none';

  document.getElementById('sumStateLabel').innerHTML = '<span class="icon">üó∫Ô∏è</span> ' + stateName + ' Tax';
  document.getElementById('sumStateRateLabel').innerHTML = '<span class="icon">üìä</span> ' + stateName + ' Rate';

  // Federal chart
  document.getElementById('fedChartTitle').textContent = 'Your Federal Tax Receipt';
  document.getElementById('fedChartSub').innerHTML = 'Your ' + fmtDollar(fedTax) + ' in federal taxes bought: <a href="https://www.cbo.gov/topics/budget" target="_blank" rel="noopener" style="font-size:0.78rem;color:var(--accent-light);text-decoration:none;opacity:0.8;">(Source ‚Üí)</a>';

  if (fedChartInstance) fedChartInstance.destroy();
  fedChartInstance = createPieChart('fedChart',
    FEDERAL_SPENDING.map(s => s.name),
    FEDERAL_SPENDING.map(s => Math.round((s.pct/100)*fedTax*100)/100),
    FEDERAL_SPENDING.map(s => s.color),
    fmtDollar(fedTax), 'Federal'
  );

  // Federal receipt
  let fedHTML = '';
  FEDERAL_SPENDING.forEach(s => {
    const amt = (s.pct/100) * fedTax;
    fedHTML += `<div class="receipt-line"><span class="cat">${s.name}</span><span class="amt">${fmtDollar(amt)}</span><span class="pct-tag">${s.pct}%</span></div>`;
  });
  fedHTML += `<div class="receipt-total"><span>TOTAL</span><span>${fmtDollar(fedTax)}</span></div>`;
  document.getElementById('fedReceipt').innerHTML = fedHTML;

  // State chart
  const isNoTax = NO_TAX_STATES.includes(stateName) || (STATE_TAX[stateName] && STATE_TAX[stateName].noTax);
  const stateChartWrapper = document.getElementById('stateChartWrapper');
  const noStateTaxNote = document.getElementById('noStateTaxNote');
  

  document.getElementById('stateChartTitle').textContent = 'Your ' + stateName + ' Tax Receipt';
  document.getElementById('stateReceiptTitle').textContent = 'üó∫Ô∏è ' + stateName.toUpperCase() + ' RECEIPT';

  if (stateChartInstance) stateChartInstance.destroy();

  if (isNoTax) {
    stateChartWrapper.style.display = 'none';
    
    noStateTaxNote.style.display = 'block';
    const noteText = (STATE_TAX[stateName] && STATE_TAX[stateName].note) ? STATE_TAX[stateName].note : stateName + ' has no state income tax.';
    noStateTaxNote.innerHTML = `<strong style="color:var(--emerald);">$0 in state income tax</strong><br><span style="font-size:0.85rem;">${noteText}</span>`;
    document.getElementById('stateChartSub').textContent = '';
    document.getElementById('stateReceipt').innerHTML = `<div style="padding:20px;text-align:center;color:#888;font-style:italic;">${stateName} has no state income tax ‚Äî nothing to break down here! üéâ</div>`;
    document.getElementById('stateReceiptThanks').style.display = 'none';
    const noTaxSourceInfo = STATE_SOURCES[stateName] || STATE_SOURCES["_default"];
    document.getElementById('stateReceiptDate').innerHTML = 'Tax Year 2025 ¬∑ <a href="' + noTaxSourceInfo.url + '" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline;text-decoration-style:dotted;">' + noTaxSourceInfo.name + '</a>';
  } else {
    stateChartWrapper.style.display = 'block';
    
    noStateTaxNote.style.display = 'none';
    document.getElementById('stateReceiptThanks').style.display = '';
    const stateSpending = STATE_SPENDING[stateName] || STATE_SPENDING_DEFAULT;
    const stateSourceInfo = STATE_SOURCES[stateName] || STATE_SOURCES["_default"];
    document.getElementById('stateChartSub').innerHTML = 'Your ' + fmtDollar(stateTax) + ' in ' + stateName + ' taxes bought: <a href="' + stateSourceInfo.url + '" target="_blank" rel="noopener" style="font-size:0.78rem;color:var(--accent-light);text-decoration:none;opacity:0.8;">(Source ‚Üí)</a>';
    document.getElementById('stateReceiptDate').innerHTML = 'Tax Year 2025 ¬∑ <a href="' + stateSourceInfo.url + '" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline;text-decoration-style:dotted;">' + stateSourceInfo.name + '</a>';

    stateChartInstance = createPieChart('stateChart',
      stateSpending.map(s => s.name),
      stateSpending.map(s => Math.round((s.pct/100)*stateTax*100)/100),
      stateSpending.map(s => s.color),
      fmtDollar(stateTax), stateName
    );

    let stateHTML = '';
    stateSpending.forEach(s => {
      const amt = (s.pct/100) * stateTax;
      stateHTML += `<div class="receipt-line"><span class="cat">${s.name}</span><span class="amt">${fmtDollar(amt)}</span><span class="pct-tag">${s.pct}%</span></div>`;
    });
    stateHTML += `<div class="receipt-total"><span>TOTAL</span><span>${fmtDollar(stateTax)}</span></div>`;
    document.getElementById('stateReceipt').innerHTML = stateHTML;
  }

  // Show results & setup reveals
  const results = document.getElementById('results');
  results.style.display = 'block';
  document.getElementById('footerCta').style.display = 'block';

  document.querySelectorAll('.reveal').forEach(el => {
    el.classList.remove('visible');
    revealObserver.observe(el);
  });

  // Trigger immediate check
  setTimeout(() => {
    document.querySelectorAll('.reveal').forEach(el => {
      const rect = el.getBoundingClientRect();
      if (rect.top < window.innerHeight) el.classList.add('visible');
    });
  }, 50);

  results.scrollIntoView({ behavior: 'smooth', block: 'start' });

  // ‚ïê‚ïê‚ïê COMPARISON SECTIONS ‚ïê‚ïê‚ïê
  updateComparison(income, stateName);
  updateNational(income, stateName);
  updateRankings(income, stateName);

  document.getElementById('comparisonSection').style.display = '';
  document.getElementById('nationalSection').style.display = '';
  document.getElementById('rankingsSection').style.display = '';

  // Budget breakdown
  document.getElementById('budgetBreakdownSection').style.display = '';
  updateBudgetBreakdown(stateName);
}

// ‚ïê‚ïê‚ïê POPULATE COMPARE DROPDOWNS ‚ïê‚ïê‚ïê
['compareStateA','compareStateB'].forEach(id => {
  const sel = document.getElementById(id);
  Object.keys(STATE_TAX).sort().forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });
});

document.getElementById('compareStateA').addEventListener('change', () => {
  const income = parseInt(incomeInput.value.replace(/[^0-9]/g,''),10);
  if(income>0) updateComparison(income);
});
document.getElementById('compareStateB').addEventListener('change', () => {
  const income = parseInt(incomeInput.value.replace(/[^0-9]/g,''),10);
  if(income>0) updateComparison(income);
});

let compareChartInstance = null;
let nationalChartInstance = null;

function updateComparison(income, currentState) {
  const selA = document.getElementById('compareStateA');
  const selB = document.getElementById('compareStateB');
  if (currentState) {
    selA.value = currentState;
    // Pick a contrasting state
    const noTaxStates = Object.keys(STATE_TAX).filter(s => STATE_TAX[s].noTax && s !== currentState);
    const highTaxStates = ['California','New York','Oregon','Minnesota','New Jersey'];
    if (STATE_TAX[currentState].noTax) {
      selB.value = highTaxStates.find(s => s !== currentState) || 'California';
    } else {
      selB.value = noTaxStates[0] || 'Texas';
    }
  }

  const stateA = selA.value;
  const stateB = selB.value;
  const taxA = calcStateTax(income, stateA);
  const taxB = calcStateTax(income, stateB);
  const rateA = income > 0 ? (taxA/income*100) : 0;
  const rateB = income > 0 ? (taxB/income*100) : 0;
  const diff = taxB - taxA;

  const diffClass = diff > 0 ? 'extra' : diff < 0 ? 'savings' : '';
  const diffText = diff === 0 ? 'Same tax burden' :
    (diff > 0 ? `You'd pay ${fmtDollar(Math.abs(diff))} more` : `You'd save ${fmtDollar(Math.abs(diff))}`) +
    ` in ${stateB} vs ${stateA}`;

  document.getElementById('compareSummary').innerHTML = `
    <div class="compare-state-box">
      <div class="cs-name">${stateA}</div>
      <div class="cs-tax">${fmtDollar(taxA)}</div>
      <div class="cs-rate">${rateA.toFixed(2)}% effective</div>
    </div>
    <div class="compare-diff ${diffClass}">
      <div class="diff-amount">${diff === 0 ? '‚Äî' : (diff > 0 ? '+' : '-') + fmtDollar(Math.abs(diff))}</div>
      <div class="diff-label">${diffText}</div>
    </div>
    <div class="compare-state-box">
      <div class="cs-name">${stateB}</div>
      <div class="cs-tax">${fmtDollar(taxB)}</div>
      <div class="cs-rate">${rateB.toFixed(2)}% effective</div>
    </div>
  `;

  // Spending comparison chart
  const spendA = STATE_SPENDING[stateA] || STATE_SPENDING_DEFAULT;
  const spendB = STATE_SPENDING[stateB] || STATE_SPENDING_DEFAULT;
  const categories = STATE_SPENDING_DEFAULT.map(s => s.name);
  const getPct = (spend, cat) => { const f = spend.find(s => s.name === cat); return f ? f.pct : 0; };

  if (compareChartInstance) compareChartInstance.destroy();
  compareChartInstance = new Chart(document.getElementById('compareChart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: categories,
      datasets: [
        { label: stateA, data: categories.map(c => getPct(spendA, c)), backgroundColor: 'rgba(99,102,241,0.7)', borderRadius: 4, barPercentage: 0.7, categoryPercentage: 0.8 },
        { label: stateB, data: categories.map(c => getPct(spendB, c)), backgroundColor: 'rgba(6,182,212,0.7)', borderRadius: 4, barPercentage: 0.7, categoryPercentage: 0.8 }
      ]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { callback: v => v + '%', color: '#94a3b8', font: { family: "'Inter'" } }, grid: { color: 'rgba(0,0,0,0.05)' } },
        y: { ticks: { color: '#5a6a7e', font: { family: "'Inter'", size: 11 } }, grid: { display: false } }
      },
      plugins: {
        legend: { labels: { color: '#5a6a7e', font: { family: "'Inter'" }, usePointStyle: true, pointStyleWidth: 10 } },
        tooltip: {
          backgroundColor: 'rgba(255,255,255,0.95)', borderColor: 'rgba(0,0,0,0.1)', borderWidth: 1,
          titleColor: '#1a2332', bodyColor: '#5a6a7e', cornerRadius: 8, padding: 12,
          callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw + '%' },
          bodyFont: { family: "'Inter'" }, titleFont: { family: "'Inter'" }
        }
      }
    }
  });
}

function updateNational(income, stateName) {
  const stateSpend = STATE_SPENDING[stateName] || STATE_SPENDING_DEFAULT;
  const categories = STATE_SPENDING_DEFAULT.map(s => s.name);
  const getPct = (spend, cat) => { const f = spend.find(s => s.name === cat); return f ? f.pct : 0; };

  document.getElementById('nationalTitle').textContent = stateName + ' vs National Average';
  document.getElementById('nationalSub').textContent = 'Spending allocation comparison ‚Äî your state vs the 50-state average';

  if (nationalChartInstance) nationalChartInstance.destroy();
  nationalChartInstance = new Chart(document.getElementById('nationalChart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: categories,
      datasets: [
        { label: stateName, data: categories.map(c => getPct(stateSpend, c)), backgroundColor: 'rgba(99,102,241,0.75)', borderRadius: 4, barPercentage: 0.7, categoryPercentage: 0.8 },
        { label: 'National Avg', data: categories.map(c => getPct(STATE_SPENDING_DEFAULT, c)), backgroundColor: 'rgba(148,163,184,0.5)', borderRadius: 4, barPercentage: 0.7, categoryPercentage: 0.8 }
      ]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { callback: v => v + '%', color: '#94a3b8', font: { family: "'Inter'" } }, grid: { color: 'rgba(0,0,0,0.05)' } },
        y: { ticks: { color: '#5a6a7e', font: { family: "'Inter'", size: 11 } }, grid: { display: false } }
      },
      plugins: {
        legend: { labels: { color: '#5a6a7e', font: { family: "'Inter'" }, usePointStyle: true, pointStyleWidth: 10 } },
        tooltip: {
          backgroundColor: 'rgba(255,255,255,0.95)', borderColor: 'rgba(0,0,0,0.1)', borderWidth: 1,
          titleColor: '#1a2332', bodyColor: '#5a6a7e', cornerRadius: 8, padding: 12,
          callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw + '%' },
          bodyFont: { family: "'Inter'" }, titleFont: { family: "'Inter'" }
        }
      }
    }
  });

  // Deviations
  let devsHTML = '';
  categories.forEach(cat => {
    const statePct = getPct(stateSpend, cat);
    const natPct = getPct(STATE_SPENDING_DEFAULT, cat);
    const diff = statePct - natPct;
    if (Math.abs(diff) > 5) {
      const cls = diff > 0 ? 'higher' : 'lower';
      const arrow = diff > 0 ? '‚Üë' : '‚Üì';
      devsHTML += `<span class="deviation-tag ${cls}">${arrow} ${cat}: ${diff > 0 ? '+' : ''}${diff}pp vs avg</span>`;
    }
  });
  document.getElementById('nationalDeviations').innerHTML = devsHTML || '<span style="font-size:0.82rem;color:var(--text-muted);">No significant deviations from national averages.</span>';
}

function updateRankings(income, stateName) {
  // Calculate all state effective rates
  const allStates = Object.keys(STATE_TAX).sort();
  const rates = allStates.map(s => ({ state: s, rate: income > 0 ? calcStateTax(income, s) / income * 100 : 0 }));
  rates.sort((a, b) => b.rate - a.rate); // highest first
  const taxRank = rates.findIndex(r => r.state === stateName) + 1;

  // Education rank (K-12 + Higher Ed)
  const eduData = allStates.map(s => {
    const sp = STATE_SPENDING[s] || STATE_SPENDING_DEFAULT;
    const k12 = (sp.find(x => x.name === 'K-12 Education') || {pct:0}).pct;
    const higher = (sp.find(x => x.name === 'Higher Education') || {pct:0}).pct;
    return { state: s, pct: k12 + higher };
  });
  eduData.sort((a, b) => b.pct - a.pct);
  const eduRank = eduData.findIndex(r => r.state === stateName) + 1;

  // Healthcare rank
  const healthData = allStates.map(s => {
    const sp = STATE_SPENDING[s] || STATE_SPENDING_DEFAULT;
    return { state: s, pct: (sp.find(x => x.name === 'Medicaid & Health') || {pct:0}).pct };
  });
  healthData.sort((a, b) => b.pct - a.pct);
  const healthRank = healthData.findIndex(r => r.state === stateName) + 1;

  const total = allStates.length;
  const stateRate = rates.find(r => r.state === stateName);
  const stateEdu = eduData.find(r => r.state === stateName);
  const stateHealth = healthData.find(r => r.state === stateName);

  function renderRankBar(containerId, rank, total, valueId, valueText) {
    document.getElementById(valueId).innerHTML = `#${rank} <span style="font-size:0.85rem;font-weight:500;color:var(--text-secondary);">of ${total}</span>`;
    const pct = ((rank - 1) / (total - 1)) * 100;
    document.getElementById(containerId).innerHTML = `
      <div class="rank-bar-track"><div class="rank-marker" style="left:${pct}%"></div></div>
      <div class="rank-bar-labels"><span>Highest</span><span>Lowest</span></div>
    `;
  }

  renderRankBar('rankTaxBar', taxRank, total, 'rankTaxValue', `#${taxRank}`);
  renderRankBar('rankEduBar', eduRank, total, 'rankEduValue', `#${eduRank}`);
  renderRankBar('rankHealthBar', healthRank, total, 'rankHealthValue', `#${healthRank}`);
}

// ‚ïê‚ïê‚ïê HEADER STATE FLAGS BACKGROUND ‚ïê‚ïê‚ïê
(function() {
  const codes = ['al','ak','az','ar','ca','co','ct','de','fl','ga','hi','id','il','in','ia','ks','ky','la','me','md','ma','mi','mn','ms','mo','mt','ne','nv','nh','nj','nm','ny','nc','nd','oh','ok','or','pa','ri','sc','sd','tn','tx','ut','vt','va','wa','wv','wi','wy'];
  const container = document.getElementById('headerFlagsBg');
  // Shuffle and repeat to fill space
  const shuffled = [...codes].sort(() => Math.random() - 0.5);
  const flags = [...shuffled, ...shuffled.sort(() => Math.random() - 0.5)];
  flags.forEach(code => {
    const img = document.createElement('img');
    img.src = 'https://flagcdn.com/48x36/us-' + code + '.png';
    img.alt = '';
    img.loading = 'lazy';
    container.appendChild(img);
  });
})();
</script>
</body>
</html>
